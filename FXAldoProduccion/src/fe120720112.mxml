<?xml version="1.0" encoding="utf-8"?>

<s:Application 
	xmlns:fx="http://ns.adobe.com/mxml/2009" 
	xmlns:s="library://ns.adobe.com/flex/spark" 
	xmlns:mx="library://ns.adobe.com/flex/mx"
	xmlns:mx2="library://ns.adobe.com/flex/halo"
	xmlns:local="*" 
	xmlns:ns="library:adobe/flex/gumbo" 
	width="100%" height="1000"
	backgroundColor="#FFFFFF" 
	creationComplete="initFact.isPopUp = true; modal.visible = true; consultaAC(); tipoMoneda.setFocus();" 
	xmlns:components="com.hillelcoren.components.*"
	applicationComplete="validateUser('fe.swf');">
	
	
	<fx:Script source="r3Take.as"/>
	<fx:Style source="fx.css" />
	<fx:Script>
		<![CDATA[
			import com.hillelcoren.utils.StringUtils;
			
			import flash.events.TimerEvent;
			import flash.utils.Timer;
			
			import mx.collections.ArrayCollection;
			import mx.core.Application;
			import mx.core.ByteArrayAsset;
			import mx.events.FlexEvent;
			import mx.formatters.NumberFormatter;
			import mx.managers.PopUpManager;
			import mx.managers.SystemManager;
			import mx.messaging.Producer;
			import mx.utils.StringUtil;
			
			import org.generalrelativity.foam.dynamics.collision.geom.AABR;
			
			private var numFtr:NumberFormatter = new NumberFormatter;
			private var numFtrXML:NumberFormatter = new NumberFormatter;
			private var pu:Number = 0;
			private var cantidad:Number = 0;
			private var imp:Number = 0;
			private var st:Number = 0;
			private var desc:Number = 0;
			private var IVA:Number = 0;
			private var ret:Number = 0;
			private var neto:Number = 0;	
			private var xmlTextV2:String ="";
			private var xmlTextV3:String ="";
			private var gbTotales:ArrayCollection = new ArrayCollection();	
			private var gbTotalesDG:ArrayCollection = new ArrayCollection();
			private var loadedASM:SystemManager;
			private var addendaComplemento:int;
			private var gb:ArrayCollection = new ArrayCollection();
			private var temporizador:Timer;
			
			
			
			
			private function setFormat():void
			{
				numFtr.precision = 2;
				numFtr.useThousandsSeparator = false;
				numFtr.useNegativeSign = true;
				numFtr.rounding = decTruncados.selected==true?"none":"nearest";
				
				
				numFtrXML.useNegativeSign = false;
			}
			private function entrar():void
			{		
				
				
				if(tipoMoneda.selectedIndex < 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar el tipo de Moneda.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					tipoMoneda.setFocus();
					tipoMoneda.errorString = "Debe seleccionar el tipo de Moneda.";
				}
				
				if(tipoMoneda.selectedItem[1].toString() == "DOLARES")
				{
					if(tasaCambio.text.length == 0)
					{
						Alert.okLabel = "Aceptar";
						Alert.show("Para poder continuar, es necesario tener una tasa de cambio, para cualquier duda contacte al administrador del sistema.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
						tasaCambio.setFocus();
						tasaCambio.errorString = "Tasa de Cambio requerida";
						return;
					}
				}		
				if(metodoPago.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Para poder continuar, es necesario agregar un método de pago, para cualquier duda contacte al administrador del sistema.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					metodoPago.setFocus();
					metodoPago.errorString = "Método de Pago requerido";
					return;
				}
				
				if(tasaValid.text == "1")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("La tasa de cambio es incorrecta, favor de corregirla.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					tasaCambio.setFocus();
					return;
				}
				
				if(tasaCambio.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("La tasa de cambio es requerida, favor de ingresarla.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					tasaCambio.setFocus();
					return;
				}
				
				if(cTipoCFDI.selectedIndex == -1||cTipoCFDI.selectedItem[0].toString()=="0"){
					
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar un Tipo de Comprobante Fiscal Digital, favor de Verificar.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					cTipoCFDI.setFocus();
					cTipoCFDI.errorString = "Tipo de Comprobante requerido";
					return;
				}
				
				if(isConfigured.text=="0"){
					
					Alert.okLabel = "Aceptar";
					Alert.show("Antes de generar el CFDI, es necesario configurarlo ingresando al Menú Catálogos > Configura tu CFDI","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					return;
				}
				if(parseInt(validaExisteClientes.text) > 0)
				{
					Send(716);//LLENA EL COMBOBOX DE IMPUESTOS DEPENDIENDO DEL TIPO DE COMPROBANTE
				}
				else
				{
					entrarFacturar.enabled = false;
					Alert.okLabel = "Aceptar";
					Alert.show("Para poder generar un CFDI es necesario tener al menos un cliente configurado.", "Mensaje FacturaXion",Alert.OK,null, null, iconDel);
					return;
				}
				
				enabledAllControls();
				
				tipoMoneda.errorString = "";
				metodoPago.errorString = "";
				tasaCambio.errorString = "";
				
				metodoPagoR.text = metodoPago.text;
				tipoMonedaR.text = tipoMoneda.selectedItem[0].toString();
				tasaCambioR.text = tasaCambio.text;
				noOrdenCompraR.text = noOrdenCompra.text;
				
				initFact.visible = false;
				
				//Campos Adicionales
				if ((parseInt(countCamposAdicionales.text) > 0)&&(countCamposAdicionales.text != ""))
				{
					Send(523); // Llena Datagrid campos Adicionales
					TTWvalores.visible = true;
					btnAdendas.visible = true;
					return;
				}
				
				TTWvalores.visible = false;
				btnAdendas.visible = false; 
				
				modal.visible = false;
				receptor.setFocus();
			}
			
			
			private function add():void
			{			
				//mx.core.Application.application.stopCountdown();
				//mx.core.Application.application. ();
				
				//var gb:ArrayCollection = new ArrayCollection();
				var validConcept:String = concepto.text;
				
				var patternME:RegExp = /[\<+]/gi;	
				var patternMA:RegExp = /[\>+]/gi;
				var patternComillas:RegExp = /[\"+]/gi;
				var patternComillasSimples:RegExp = /[\'+]/gi;
				
				while (validConcept.search(patternME) != -1 )
				{
					validConcept = validConcept.replace(patternME, "");
				}
				while (validConcept.search(patternMA) != -1 )
				{
					validConcept = validConcept.replace(patternMA, "");
				}
				while (validConcept.search(patternComillas) != -1 )
				{
					validConcept = validConcept.replace(patternComillas, "");
				}
				while (validConcept.search(patternComillasSimples) != -1 )
				{
					validConcept = validConcept.replace(patternComillasSimples, "&apos;");
				}
				
				concepto.text = validConcept;
				
				setFormat();		
				if(concepto.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe especificar el concepto.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					concepto.setFocus();
					concepto.errorString = "Debe especificar el concepto";
					return;
				}
				if(um.selectedIndex < 0)
				{		
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar una Unidad de Medida.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					um.setFocus();
					um.errorString = "Debe seleccionar una Unidad de Medida";
					return;
				}
				if(cant.text.length == 0 || cant.text == "0")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe especificar la cantidad y esta no puede ser cero..","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					cant.setFocus();
					cant.errorString = "Debe especificar la cantidad";
					return;
				}
				if(precio.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe especificar el Precio.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					precio.setFocus();
					precio.errorString = "Debe especificar el Precio";
					return;
				}
				
				if(impuesto.selectedIndex < 0)
				{			
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar el impuesto.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					impuesto.setFocus();
					impuesto.errorString = "Debe seleccionar el impuesto";
					return;
				}
				
				if(precioValid.text == "1")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("El Precio no tiene el formato correcto.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					precio.setFocus();
					return;				
				}
				
				if(cantValid.text == "1")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("La Cantidad es numérico con seis posiciones decimales.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					cant.setFocus();
					return;	
				}
				
				if(precio.text == "" || parseFloat(precio.text) <= 0.00)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("El precio debe ser mayor a 0.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					precio.setFocus();
					precio.errorString = "El precio debe ser mayor a 0","Error en precio";
					return;	
				}
				
				
				
				if(conceptos.dataProvider != null)
				{
					gb = new ArrayCollection(ArrayUtil.toArray(conceptos.dataProvider.source));
				}
				
				pu = Number(precio.text.replace(/,/g, "")); 
				cantidad=Number(cant.text);
				st = (cantidad * pu*100)/100;
				desc = st * (descuento.value/100);
				
				var valsImp:Array = new Array();
				var valsImpDet:Array = new Array();
				var descString:String = "";
				
				
				valsImp = impuesto.selectedItem[0].toString().split("#");
				
				for(var imp:int=0; imp < valsImp.length; imp++)
				{            	
					valsImpDet = valsImp[imp].toString().split("|");
					
					var porcentImp:Number = Number(valsImpDet[1]);
					
					if(porcentImp > 0)
					{
						descString += "Traslados " + valsImpDet[0] + " " + valsImpDet[1].toString() + ": $ " + numFtr.format(((porcentImp / 100) * (st - desc))) + " \n";            		           		
					}else if(porcentImp < 0)
					{
						descString += "Retención " + valsImpDet[0] + " " + valsImpDet[1].toString() + ": $ " + numFtr.format(((porcentImp / 100) * (st - desc))) + " \n";
					}  
				}
				
				//Agregamos la partida al arreglo gb
				gb.addItem(
					{0:concepto.text, 
						1:cantidad, 
						2:numFtr.format(pu), 
						3:numFtr.format((cantidad* pu*100 )/100),
						4:descuento.value.toString(), 
						5:numFtr.format(desc),
						6:impuesto.selectedItem[0],				 
						7:um.selectedItem[0].toString(),
						8:impuesto.selectedItem[1].toString(),
						9:((descuento.value!=0) ? "Descuento " + descuento.value.toString() + "% : " + numFtr.format(desc)+ "    \n": "\n") + descString,
						10:numFtr.format(((cantidad * pu*100)/100) - desc),
						11:impuesto.selectedItem[0],
						12:numFtrXML.format(((cantidad * pu*100)/100)- desc),
						13:impuesto.selectedItem[2].toString(),
						14:um.selectedItem[1].toString(),
						15:((cantidad * pu*100)/100) - desc,
						16:desc
					}
				);
				
				calcular(gb);  
				
				conceptos.dataProvider = gb;
				autocompleteProductosText.text = "";
				descuento.value = 0;
				um.selectedIndex = -1;
				concepto.text = "";
				impuesto.selectedIndex = 0;
				cant.text = "1";
				precio.text = "0.00";	
				
				autocompleteProductosText.selectedItem = null;
				concepto.text = "";
				autocompleteProductosText.dataProvider = acACProductos;
			}
			
			
			private function calcular(gb:ArrayCollection):void
			{
				var total:Number = 0;
				var subTotal:Number = 0;
				var error:String="";
				var stAcumulado:Number=0;
				var impDet:Array = new Array();
				var valsImpDet:Array = new Array();
				var porcentImp:Number = 0;
				var conceptImp:String = "";
				var impNuevo:int = 0;
				var esTotal:int = 0;
				var palabraRet:String = "";
				var valueImp:Number = 0;
				
				
				gbTotales = new ArrayCollection(); 
				
				gbTotales = new ArrayCollection(ArrayUtil.toArray(totales.dataProvider.source));
				
				//Inicializamos variables númericas del arreglo gbTotales
				for(var numgbTotales:int=0; numgbTotales < gbTotales.length; numgbTotales++)
				{
					gbTotales[numgbTotales][1] = 0;
					gbTotales[numgbTotales][3] = 0;
					gbTotales[numgbTotales][5] = 0;
				}
				var usaIVAIEPS:Boolean;
				//Recorremos el arreglo gb, que contiene el arreglo de impuestos de la tabla de impuestosDetalle
				for(var numImpDet:int=0; numImpDet < gb.length; numImpDet++)
				{
					//Validamos para este concepto el uso del IVA sobre IEPS
					if(	gb[numImpDet][8].toString()=="IVA 16% SOBRE IEPS 53%"||
						gb[numImpDet][8].toString()=="IVA 16% SOBRE IEPS 30%"||
						gb[numImpDet][8].toString()=="IVA 16% SOBRE IEPS 25%")
					{
						usaIVAIEPS=true;
					}
					else
					{
						usaIVAIEPS=false;
					}
					impDet = gb[numImpDet][11].toString().split("#");
					
					for(var imp:int=0; imp < impDet.length; imp++)
					{            	
						valsImpDet = impDet[imp].toString().split("|");	            	
						porcentImp= Number(valsImpDet[1]);
						conceptImp= valsImpDet[0].toString();
						
						//Validamos que el impuesto no sea cero, para continuar con el calculo
						if(porcentImp != 0)
						{  	    
							//Por cada impuesto de la tabla de impuestoDetalle, recorremos el arreglo del Subtotal, total y los impuestos agregados.
							for(var impTotales:int=0; impTotales < gbTotales.length; impTotales++)
							{		 
								//Si los impuestos coinciden es decir se tenemos una partida de 16 % de IVA y se agrega una con el mismo impuesto, las cifras las suma
								if(gbTotales[impTotales][0].toString() == valsImpDet[0].toString() + " " + Number(valsImpDet[1]).toString().replace(".00", "") && (gbTotales[impTotales].hasOwnProperty([6]) && gbTotales[impTotales][6]==usaIVAIEPS || valsImpDet[0].toString()!="IVA") )
								{
									gbTotales[impTotales][1] += ((porcentImp / 100) * (Number(gb[numImpDet][15])));
									gbTotales[impTotales][3] = numFtr.format(Math.abs(gbTotales[impTotales][1]));
									gbTotales[impTotales][5] = Math.abs(valsImpDet[1]).toString();
									impNuevo = 1;
								}           			
							}
							
							//Si el impuesto no coincide en la validación anterior, significa que el impuesto es diferente, y hay que crearlo
							if(impNuevo == 0)
							{
								
								if(Number(valsImpDet[1]) < 0)
								{
									//Si el impuesto es menor que cero es una retención
									palabraRet = "";
								}
								else
								{
									//Si el impuesto es menor que cero es un traslado
									palabraRet = "";
								}
								//Agregamos al arreglo gbTotales el nuevo impuesto
								gbTotales.addItem({	0:valsImpDet[0].toString() + " " + Number(valsImpDet[1]),  
													1:(porcentImp / 100) * (Number(gb[numImpDet][15])), 
													2: palabraRet + valsImpDet[0].toString() + " " + Math.abs(Number(usaIVAIEPS==true && valsImpDet[0].toString()=="IVA" ? "16.00" : valsImpDet[1]))  + " %", 
													3:numFtr.format(((Math.abs(porcentImp) / 100) * (Number(gb[numImpDet][15])))), //antes el último multiplicando era: st-desc
													4:valsImpDet[0].toString(), 
													5:Math.abs(valsImpDet[1]).toString(), 
													6:usaIVAIEPS==true && valsImpDet[0].toString()=="IVA" ? true:false });
								
							}
							else
							{
								impNuevo = 0;
							} 
						}
					}
				}
				
				//Sumamos la lista de importes para sacar el Total
				for(var numDetImp:int=0; numDetImp < gb.length; numDetImp++)
				{    			
					subTotal += Number(gb[numDetImp][10]);           			
				}
				//Damos formato y lo agregamos al arreglo gbTotales
				gbTotales[0][1] = subTotal;
				gbTotales[0][3] = numFtr.format(subTotal);
				
				var numTotalImp:int = gbTotales.length;
				
				//	Recorremos todo el arreglo para realizar ordenamiento, ya que debe de estar como Subtotal, lista de impuestos, y total.	
				for(var numImpuesto:int=0; numImpuesto < gbTotales.length; numImpuesto++)
				{ 
					//Si la descripción es igual a Total, lo eliminamos para despues agregarlo al final.
					if(gbTotales[numImpuesto][0].toString() == "Total")
					{
						gbTotales.removeItemAt(numImpuesto);
					}
					
					if(gbTotales.length > numImpuesto)
					{
						//Calculamos el total
						total = ((total*100) + (gbTotales[numImpuesto][1]*100))/100;
						
						if(gbTotales[numImpuesto][1].toString() == "0" && gbTotales[numImpuesto][0].toString() != "Subtotal" && gbTotales[numImpuesto][0].toString() != "Total")
						{
							gbTotales.removeItemAt(numImpuesto);
							numTotalImp = numTotalImp -1;		
						}
					}							    			     			
				}  
				
				numTotalImp = gbTotales.length;
				for(var numImpuesto:int=0; numImpuesto < gbTotales.length; numImpuesto++)
				{     			
					if(gbTotales.length > numImpuesto)
					{					
						if(gbTotales[numImpuesto][1].toString() == "0" && gbTotales[numImpuesto][0].toString() != "Subtotal" && gbTotales[numImpuesto][0].toString() != "Total")
						{
							gbTotales.removeItemAt(numImpuesto);
							numTotalImp = numTotalImp -1;		
						}
					}							    			     			
				}
				
				//Agregamos el Total, que era el que quitamos anteriormente, y lo ponemkos justo al final del Arreglo para finalizar con el ordenamiento.
				if(gbTotales[gbTotales.length - 1][0].toString() != "Total")
				{
					gbTotales.addItem({0:"Total",  1:total, 2:"Total", 3:numFtr.format(total), 4:"", 5:0});
				}
				else
				{
					gbTotales.removeItemAt(gbTotales.length - 1);            
					gbTotales.addItem({0:"Total",  1:total, 2:"Total", 3:numFtr.format(total), 4:"", 5:0});
				}
				for(numgbTotales =0;numgbTotales<gbTotales.length;numgbTotales++)
				{
					gbTotales[numgbTotales][1]=truncaRedondeaDecimales((decTruncados.selected==true?0:1),gbTotales[numgbTotales][1],2);
				}
				totales.dataProvider = gbTotales;
				
				
			}	
			
			private function addTotales():void
			{
				gbTotales.addItem({0:"Subtotal",  1:0, 2:"Subtotal", 3:0, 4:"", 5:0});
				gbTotales.addItem({0:"Total",  1:0, 2:"Total", 3:0,4:"", 5:0});
				
				totales.dataProvider =gbTotales;
			}
			
			private function remove():void
			{
				var gb:ArrayCollection = new ArrayCollection();
				
				if(conceptos.selectedIndex < 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar el concepto a eliminar.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					conceptos.setFocus();
					conceptos.errorString = "Debe seleccionar el concepto a eliminar";
					return;
				}
				if(conceptos.dataProvider != null)
				{
					gb = new ArrayCollection(ArrayUtil.toArray(conceptos.dataProvider.source));
				}
				gb.removeItemAt(conceptos.selectedIndex);
				conceptos.dataProvider = gb;
				calcular(gb);	            
			}
			
			private function generarDocumento():void
			{
				Send(167);	            
			}
			
			
			private function ayuda():void
			{
				navigateToURL(new URLRequest("http://fx.facturaxion.com/facturaxion/ayuda/factura/factura.htm"),"_blank");
			}
			
			import mx.events.CloseEvent;
			
			private function validaGenerarFactura():void
			{
				if(conceptos.dataProvider == null || conceptos.rowCount == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe de crear al menos un concepto.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					concepto.setFocus();
					return;
				}
				
				if(receptor.selectedIndex < 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe de seleccionare un receptor.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					receptor.setFocus();
					receptor.errorString = "Seleccione un receptor.";
					return;
				}
				
				if(folio.selectedIndex < 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Debe de seleccionare una serie.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					folio.setFocus();
					folio.errorString = "Seleccione una serie.";
					return;
				}	
				
				
				Alert.yesLabel = "Sí";
				Alert.noLabel = "No";
				Alert.cancelLabel = "Cancelar";
				Alert.okLabel = "Aceptar"
				Alert.show("¿Está seguro de querer generar el CFDI?", "Mensaje FacturaXion", Alert.OK | Alert.CANCEL, this, alertListener, iconQuestion, Alert.OK);
				return;
				
			}
			
			private function alertListener(eventObj:CloseEvent):void
			{
				if (eventObj.detail==Alert.OK) 
				{
					//En el siguiente segmento de código 
					//se unifica el IVA 16 % sobre IEPS,
					//si lo hay, con el IVA ordinario
					var posicionesIVAIEPS:ArrayCollection=new ArrayCollection();
					//var foundIVAIEPS:Boolean=false;
					var found1600:Boolean=false;
					var idxIVAIEPS:int=1;
					var idx1600:int=1;
					//Rastramos si se usó un IVA sobre IEPS
					do
					{
						if(gbTotales[idxIVAIEPS][6]==true)
						{
							posicionesIVAIEPS.addItem(idxIVAIEPS);
							//foundIVAIEPS=true;
						}
						idxIVAIEPS++;
					}
					while(idxIVAIEPS<gbTotales.length-1 );
					
					//Rastreamos si se usó un IVA 16 Trasladado%
					do
					{
						if(gbTotales[idx1600][0]=="IVA 16" && gbTotales[idx1600][1]>=0)
						{
							found1600=true;
						}
						else
						{
							found1600=false;
							idx1600++;
						}
					}
					while(idx1600<gbTotales.length-1 && found1600==false);
					if(posicionesIVAIEPS.length>0)
					{
						//Si se usó algún IVA sobre IEPS, se enmascara como normal
						var idxPosiciones:int;
						for(idxPosiciones=0;idxPosiciones<posicionesIVAIEPS.length;idxPosiciones++)
						{
							gbTotales[posicionesIVAIEPS[idxPosiciones]][0]="IVA 16.00";
							gbTotales[posicionesIVAIEPS[idxPosiciones]][5]="16.00";
						
							if(found1600==true)
							{
							//Pero si se usó el IVA 16 Trasladado, este 
							//absorve al IVA sobre IEPS
								gbTotales[idx1600][1]=(Number(gbTotales[idx1600][1])+Number(gbTotales[posicionesIVAIEPS[idxPosiciones]][1]));
								gbTotales[idx1600][3]=numFtr.format(Number(gbTotales[idx1600][3])+Number(gbTotales[posicionesIVAIEPS[idxPosiciones]][3]));
							}
							else
							{
								//En cambio si no se usó IVA 16 Trasladado
								//se unificarán todos los IVA sobre IEPS en el primero
								if(idxPosiciones>0)
								{
									gbTotales[posicionesIVAIEPS[0]][1]=(Number(gbTotales[posicionesIVAIEPS[0]][1])+Number(gbTotales[posicionesIVAIEPS[idxPosiciones]][1]));
									gbTotales[posicionesIVAIEPS[0]][3]=numFtr.format(Number(gbTotales[posicionesIVAIEPS[0]][3])+Number(gbTotales[posicionesIVAIEPS[idxPosiciones]][3]));
								}
							}
						}
						//Eliminaremos los IVAs sobrantes
						for(idxPosiciones=posicionesIVAIEPS.length-1;idxPosiciones>=(found1600==true?0:1);idxPosiciones--)
						{
							gbTotales.removeItemAt(posicionesIVAIEPS[idxPosiciones]);
						}
					}
					//**************************************
					
					importeTotal.text=gbTotales[gbTotales.length-1][1].toString();
					modal.visible = true;
					receptor.errorString = "";
					folio.errorString = "";
					if (parseInt(cCountAddendas.text)>0 || usaDonatarias.selected==true)
					{
						contenedorAddenda.visible=true;
						
						if (usaDonatarias.selected==true)
						{
							listadoAddendasReceptor.visible=false;
							listadoAddendasReceptor.enabled=false;
							lblComplementoNombre.text="Donatarias 1.0";
							lblComplementoNombre.visible=true;
							addendaComplemento=2; //Será un complemento
							usaAddenda.text="2";
						}
						else
						{
							listadoAddendasReceptor.visible=true;
							listadoAddendasReceptor.enabled=true;
							lblComplementoNombre.visible=false;
							addendaComplemento=1; //Será una addenda
							usaAddenda.text="1";
							
						}
						Send(679);
						
					}
					else
					{
						//Ni addenda ni complemento
						usaAddenda.text="0";
						sendGeneraCFDI();
					}
					//Se extrae el send a la función sendGeneraFactura(), para
					//no duplicar la llamada por el lado de la addenda
					//Send(227);
				}
			}
			
			private function sendGeneraCFDI()
			{
				Send(227);
			}
			
			private function setTasa():void
			{
				if(tipoMoneda.selectedIndex > -1)
				{
					if(tipoMoneda.selectedItem[1].toString()=="DOLARES")
					{
						tasaCambio.text = tipoMoneda.selectedItem[2].toString();
						tasaCambio.editable = true;
					}
					else if(tipoMoneda.selectedItem[1].toString()=="PESOS")
					{
						tasaCambio.text = "1";
						tasaCambio.editable = false;
					}
					else
					{
						tasaCambio.text = "";
						tasaCambio.editable = true;
					}
				}
				
			}
			
			private function setTipoCFDI():void
			{
				if(cTipoCFDI.selectedIndex > -1)
				{
					countCamposAdicionales.text = "";
					
					if(cTipoCFDI.selectedItem[0].toString()=="1"){//FACTURA
						tipoCFDI.text = "ingreso";
						tipoComprobante.text = cTipoCFDI.selectedItem[0].toString();
					}
					else if(cTipoCFDI.selectedItem[0].toString()=="2"){//NOTA DE CREDITO
						tipoCFDI.text = "egreso"
						tipoComprobante.text = cTipoCFDI.selectedItem[0].toString();
					}
					else if(cTipoCFDI.selectedItem[0].toString()=="3"){//RECIBO DE ARRENDAMIENTO
						tipoCFDI.text = "ingreso";
						tipoComprobante.text = cTipoCFDI.selectedItem[0].toString();
					}
					else if(cTipoCFDI.selectedItem[0].toString()=="4"){//RECIBO DE HONORARIOS
						tipoCFDI.text = "ingreso"
						tipoComprobante.text = cTipoCFDI.selectedItem[0].toString();
					}
					else if(cTipoCFDI.selectedItem[0].toString()=="5"){//CARTA PORTE
						tipoCFDI.text = "traspaso"
						tipoComprobante.text = cTipoCFDI.selectedItem[0].toString();
					}
					
					Send(626); //Verifica si el tipo de comprobante tiene campos adicionales
				}
				Send(701);//INDICA SI EL USUARIO CONFIGURO EL CFDI A GENERAR
			}
			
			private function seleccionarReceptor():void
			{
				/* if(receptor.textInput.text.length > 2)
				{
				Send(639);
				} */
				
				if(receptor.selectedIndex > -1)
				{
					idSucursalReceptor.text = receptor.selectedItem[13].toString();
					rfcReceptor.text = receptor.selectedItem[2].toString();
					idReceptor.text = receptor.selectedItem[0].toString();
					nombreReceptor.text = receptor.selectedItem[1].toString();
					Send(678);
				}
			}
			
			private function salir():void
			{
				
				mx.controls.SWFLoader(findObject("globalLoader", "SWFLoader")).source ="init.swf";
				
			}
			
			[Bindable]	private var _contacts:ArrayCollection;
			
			[Bindable]  private var myFileClass:Class; 
			
			public function dropDownLabelFunction( item:Object ):String
			{
				var string:String = item[0];
				var searchStr:String = autocompleteProductosText.searchText;
				
				var returnStr:String = StringUtils.highlighMatch( string, searchStr, AutoComplete.MATCH_WORD );
				
				if (autocompleteProductosText.selectedItems.getItemIndex( item ) >= 0)
				{
					returnStr = "<font color='" + Consts.COLOR_TEXT_DISABLED + "'>" + returnStr + "</font>";
				}
				
				return returnStr;
			}
			
			private function consultaAC():void
			{
				
				Send(627);
				disableAllcontrols();
				Send(560);
			}
			
			private function enabledAllControls():void
			{
				receptor.enabled = true;
				folio.enabled = true;
				autocompleteProductosText.enabled = true;
				um.enabled = true;
				cant.enabled = true;
				precio.enabled = true;
				descuento.enabled = true;
				impuesto.enabled = true;
				btnAddProducto.enabled = (Number(idRol.text)==16?false:true);
				agregar.enabled = true;
				eliminar.enabled = true;
				observaciones.enabled = true;
				generar.enabled = true;
				conceptos.enabled = true;	
				conHead.enabled = true;	
				totales.enabled = true;	
				usaDonatarias.enabled=true;
			}
			
			private function disableAllcontrols():void
			{
				receptor.enabled = false;
				folio.enabled = false;
				autocompleteProductosText.enabled = false;
				um.enabled = false;
				cant.enabled = false;
				precio.enabled = false;
				descuento.enabled = false;
				impuesto.enabled = false;
				btnAddProducto.enabled = false;
				agregar.enabled = false;
				eliminar.enabled = false;
				observaciones.enabled = false;
				generar.enabled = false;
				conceptos.enabled = false;	
				conHead.enabled = false;	
				totales.enabled = false;
				usaDonatarias.enabled=false;
			}
			
			private var acACProductos = new ArrayCollection();
			private function loadACproductos():void
			{	
				
				acACProductos = new ArrayCollection(ArrayUtil.toArray(acProductosGV.dataProvider.source));
				
				autocompleteProductosText.dataProvider = acACProductos;		
			}
			
			private function verItemSelect():void
			{			
				concepto.text = autocompleteProductosText.text;
				
				if(autocompleteProductosText.selectedItems.source.length > 0)	
				{			
					acProductoPasoText.text = autocompleteProductosText.selectedItems[0].toString();	
				}
				else
				{			
					acProductoPasoText.text = "";							
				}
			}
			
			private function fillControls():void
			{
				if(acProductoPasoText.text.length > 0)
				{		
					Send(289);
				}
				else
				{
					concepto.text = "";
					precio.text = "";
					um.selectedIndex = 0;			
				}
			}
			
			private function addProductoAndValid():void
			{
				if(descripcionAdd.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Para agregar el producto es necesario ingresar una descripción.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					descripcionAdd.setFocus();
					descripcionAdd.errorString = "Debe especificar la descripción.";
					return;
				}
				
				if(descripcionCortaAdd.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Para agregar el producto es necesario ingresar una descripción corta.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					descripcionCortaAdd.setFocus();
					descripcionCortaAdd.errorString = "Debe especificar la descripción corta.";
					return;
				}
				
				if(precioUnitarioAdd.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Para agregar el producto es necesario ingresar un precio unitario.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					precioUnitarioAdd.setFocus();
					precioUnitarioAdd.errorString = "Debe especificar el precio.";
					return;
				}
				
				if(precioAddValid.text == "1")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("El Precio es numérico con seis posiciones decimales.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					precioUnitarioAdd.setFocus();
					return;				
				}
				
				if(umAdd.selectedIndex < 0)
				{		
					Alert.okLabel = "Aceptar";
					Alert.show("Debe seleccionar una Unidad de Medida.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					umAdd.setFocus();
					umAdd.errorString = "Debe especificar la unidad de medida.";
					return;
				}		
				
				modal.visible = false;
				enabledAllControls();
				Send(290);
				Send(560);		
				addProducto.visible = false;
				descripcionAdd.text = "";
				descripcionCortaAdd.text = "";
				precioUnitarioAdd.text = "";
				umAdd.selectedIndex = 0;
			}
			
			private function navegarPDF():void
			{
				var rutaPDFExtern
				if(rutaPDF.text.indexOf("fx.facturaxion.com") == -1)
				{
					rutaPDFExtern = rutaPDF.text.substr(11, rutaPDF.text.length);
				}
				else
				{
					rutaPDFExtern = rutaPDF.text.replace("http://fx.facturaxion.com/", "");
				}
				
				var request:URLRequest = new URLRequest(rutaPDFExtern);
				request.contentType = "application/pdf";
				var fileRef:FileReference = new FileReference();
				navigateToURL(request, '_blank');	
			}
			
			private function navegarXML():void
			{
				var rutaArchivoXML:String;
				rutaArchivoXML=rutaPDF.text;
				rutaArchivoXML=rutaArchivoXML.replace(".pdf",".xml");
				var rutaPDFExtern;
				
				if(rutaArchivoXML.indexOf("fx.facturaxion.com") == -1)
				{
					rutaPDFExtern = rutaArchivoXML.substr(11, rutaArchivoXML.length);
				}
				else
				{
					rutaPDFExtern = rutaArchivoXML.replace("http://fx.facturaxion.com/", "");
				}
				
				var request:URLRequest = new URLRequest(rutaPDFExtern);
				//request.contentType = "application/pdf";
				var fileRef:FileReference = new FileReference();
				navigateToURL(request, '_blank');	
			}
			
			private function enviarFactEmail():void
			{
				//To - Do: Validar la Expresion regular del Email
				if(correo.text.length == 0)
				{
					Alert.okLabel = "Aceptar";
					Alert.show("Para enviar el CFDI es necesario ingresar un correo electrónico, favor de ingresarlo.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);				
					correo.setFocus();
					correo.errorString = "Debe especificar un correo electrónico.";
					return;
				}
				
				if(!expMail.test(correo.text))
				{
					Alert.okLabel = "Aceptar";
					Alert.show("El formato de correo electrónico no es correcto.","Mensaje FacturaXion",Alert.OK,null,null, iconAlert);
					correo.setFocus();
					correo.errorString = "El formato de correo electrónico no es correcto.";
					return;
				} 	
				Send(489);//Envía CFD por Correo.
			}
			
			[Embed(source="assets/delete-icon_32.png")]	[Bindable] public var iconFail:Class;
			[Embed(source="assets/accept-icon_32.png")] [Bindable] public var iconOK:Class;
			[Embed(source="assets/2519-32.png")] 		[Bindable] public var iconQuestion:Class;
			
			private function validSendEmail():void
			{
				if(correoEnviado.text == "1")
				{
					Alert.okLabel = "Aceptar";
					Alert.yesLabel = "Sí";
					Alert.noLabel = "No";
					Alert.show("El Comprobante Fiscal Digital se ha enviado de manera correcta.", "Mensaje FacturaXion",Alert.OK, null, doReNew, iconOk);
				}
				else if(correoEnviado.text == "0")
				{
					Alert.okLabel = "Aceptar";
					Alert.show("El Comprobante Fiscal Digital no se pudo enviar de manera correcta, intente nuevamente.", "Mensaje FacturaXion",Alert.OK,null, null, iconDel);
				}
				correoEnviado.text="";
			}
			
			private function doReNew(eventObj:CloseEvent):void
			{
				if (eventObj.detail==Alert.YES) 
				{
					closeTWCFD();
				}
			}
			
			private var expMail:RegExp = /^[\w-]+(?:\.[\w-]+)*@(?:[\w-]+\.)+[a-zA-Z]{2,7}$/;
			
			private function checkMail(myCtrl:spark.components.TextInput):void
			{
				if(expMail.test(myCtrl.text))
				{
					myCtrl.errorString = "";
				}
				else
				{				
					myCtrl.errorString = "Correo electrónico Incorrecto\n\n" +
						"Formato “cuenta1.cuenta2@dominio.com ” \n" +
						"“El campo Para sólo permite un Destinatario, si necesita enviar a más destinatarios utilice el campo CC y CCo”";
				}			
			}
			
			private function closeTWCFD():void
			{
				mx.controls.SWFLoader(findObject("globalLoader", "SWFLoader")).source ="nada.swf";
				mx.controls.SWFLoader(findObject("globalLoader", "SWFLoader")).source ="fe.swf";			
			}
			
			private function viewTWCFD():void
			{
				if(rutaPDF.text.length > 0)
				{
					modal.visible = true;
					factura.visible=true;
					factura.isPopUp = true;
					correoVPara.setFocus();
				}
			}
			
			private function cargaDatos():void
			{
				if(parseInt(validaExisteClientes.text) > 0)
				{
					Send(155);
				}
				else
				{
					entrarFacturar.enabled = false;
					Alert.okLabel = "Aceptar";
					Alert.show("Para poder generar un CFDI es necesario tener al menos un cliente configurado.", "Mensaje FacturaXion",Alert.OK,null, null, iconDel);
				}
			}
			
			private function muestraValIdConFactDetDesc():void
			{
				if (GWV_FECamposValores.selectedIndex > -1)
				{
					idConFactDetDesc.text = GWV_FECamposValores.selectedItem["0"].toString();
					LBLDescripcion.text = '*' + GWV_FECamposValores.selectedItem["1"].toString();
				}
			}
			
			private function muestraTTWcambiaValor():void
			{
				Send(522); //Trae valor
				TTWvalores.enabled = false;
				TTWcambiaValor.visible = true;	
			}
			
			private function actualizaValor():void
			{
				Send(524); //Actualiza el Valor del Campo
				Send(523); //Actualiza Data Grid
				valor.text = "";
				TTWvalores.enabled = true;
				TTWcambiaValor.visible = false;	
			}
			
			private function cargaPantallaAddenda():void
			{
				addendaLoader.addEventListener(Event.COMPLETE,controlPantallaAddenda);
				if(addendaComplemento==2)
				{
					addendaLoader.source="complementoDonatarias10.swf";
					cargaAddenda.enabled=false;
				}
				else if (listadoAddendasReceptor.selectedIndex>-1)
				{
					addendaLoader.source=listadoAddendasReceptor.selectedItem[2].toString();
					cargaAddenda.enabled=false;
					listadoAddendasReceptor.enabled=false;
				}
				else
				{
					Alert.okLabel="Aceptar";
					Alert.show("Seleccione por favor la Addenda a utilizar.","Aviso",Alert.OK,null,null, iconAlert);
				}
			}
			
			private function controlPantallaAddenda(loaderEvent:Event):void
			{
				loadedASM= SystemManager(addendaLoader.content);
				loadedASM.addEventListener(Event.COMPLETE,recogeAddenda);
				loadedASM.addEventListener(mx.events.FlexEvent.APPLICATION_COMPLETE,datosDeEnvio,false,0,false);
			}
			
			private function recogeAddenda(readyAddenda:Event):void
			{
				//usaAddenda.text="1";
				addendaContenido.text=loadedASM.application["addendaValor"].toString();
				if (listadoAddendasReceptor.selectedIndex!=-1)
				{
					idAddenda.text=listadoAddendasReceptor.selectedItem[0].toString();
					definidoEn.text=(listadoAddendasReceptor.selectedItem[7].toString().length>0?listadoAddendasReceptor.selectedItem[7].toString():"X");
					nameSpace.text=listadoAddendasReceptor.selectedItem[3].toString();
					locNameSpace.text=listadoAddendasReceptor.selectedItem[4].toString();
					nombreSchema.text=listadoAddendasReceptor.selectedItem[5].toString();
					locSchema.text=listadoAddendasReceptor.selectedItem[6].toString();
				}
				else
				{
					idAddenda.text="-1";
					definidoEn.text="";
					nameSpace.text="";
					locNameSpace.text="";
					nombreSchema.text="";
					locSchema.text="";
				}
				cierraAddenda(null);
			}
			
			private function datosDeEnvio(sendData:FlexEvent):void
			{
				var inputAddendas:XML=new XML("<Documento/>")
				inputAddendas.@['numeroOrdenCompra']=noOrdenCompra.text;
				inputAddendas.@['tipoComprobante']=tipoCFDI.text;
				inputAddendas.@['importeTotalLetra']=importeTotalLetra.text;
				
				if (listadoAddendasReceptor.selectedIndex!=-1)
				{
					inputAddendas.@['definidoEn']=listadoAddendasReceptor.selectedItem[7];
					inputAddendas.@['nameSpace']=listadoAddendasReceptor.selectedItem[3];
					inputAddendas.@['locNameSpace']=listadoAddendasReceptor.selectedItem[4];
					inputAddendas.@['nombreSchema']=listadoAddendasReceptor.selectedItem[5];
					inputAddendas.@['locSchema']=listadoAddendasReceptor.selectedItem[6];
				}
				else
				{
					inputAddendas.@['definidoEn']="";
					inputAddendas.@['nameSpace']="";
					inputAddendas.@['locNameSpace']="";
					inputAddendas.@['nombreSchema']="";
					inputAddendas.@['locSchema']="";
				}
				
				var emisorInput:XML=new XML("<emisor/>");
				emisorInput.@['idEmpresa']=idEmisor.text;
				emisorInput.@['nombre']=nombreEmisor.text;
				emisorInput.@['rfc']=rfcEmisor.text;
				var emisorMatriz:XML= new XML("<emisorMatriz/>");
				emisorMatriz.@['idSucursal']=idSucursalMatriz.text;
				emisorMatriz.@['nombre']=nombreSucursalMatriz.text;
				emisorMatriz.@['calle']=calleMatriz.text;
				emisorMatriz.@['exterior']=noExtMatriz.text;
				emisorMatriz.@['interior']=noIntMatriz.text;
				emisorMatriz.@['colonia']=coloniaMatriz.text;
				emisorMatriz.@['ciudad']=ciudadMatriz.text;
				emisorMatriz.@['municipio']=municipioMatriz.text;
				emisorMatriz.@['cp']=cpMatriz.text;
				emisorMatriz.@['estado']=estadoMatriz.text;
				emisorMatriz.@['pais']=paisMatriz.text;
				emisorMatriz.@['email']=emailSucMatriz.text;
				
				var emisorEmitidoEn:XML= new XML("<emisorEmitidoEn/>");
				emisorEmitidoEn.@['idSucursal']=idSucursalEmisor.text;
				emisorEmitidoEn.@['nombre']=nombreSucursalEmitidoEn.text;
				emisorEmitidoEn.@['calle']=calleEmitidoEn.text;
				emisorEmitidoEn.@['exterior']=noExtEmitidoEn.text;
				emisorEmitidoEn.@['interior']=noIntEmitidoEn.text;
				emisorEmitidoEn.@['colonia']=coloniaEmitidoEn.text;
				emisorEmitidoEn.@['ciudad']=ciudadEmitidoEn.text;
				emisorEmitidoEn.@['municipio']=municipioEmitidoEn.text;
				emisorEmitidoEn.@['cp']=cpEmitidoEn.text;
				emisorEmitidoEn.@['estado']=estadoEmitidoEn.text;
				emisorEmitidoEn.@['pais']=paisEmitidoEn.text;
				emisorEmitidoEn.@['email']=emailSucEmitidoEn.text;
				
				emisorInput.appendChild(emisorMatriz);
				emisorInput.appendChild(emisorEmitidoEn);
											
				inputAddendas.appendChild(emisorInput);
				
				var receptorInput:XML = new XML ("<receptor/>");
				var receptorDomicilio:XML= new XML("<receptorDomicilio/>");
				
				receptorInput.@['idEmpresa']=receptor.selectedItem[0].toString();
				receptorInput.@['razonSocial']=receptor.selectedItem[1];
				receptorInput.@['rfc']=receptor.selectedItem[2];
				
				receptorDomicilio.@['idSucursal']=receptor.selectedItem[13];
				receptorDomicilio.@['nombreSucursal']=receptor.selectedItem[3];
				receptorDomicilio.@['calle']=receptor.selectedItem[4];
				receptorDomicilio.@['noExt']=receptor.selectedItem[9];
				receptorDomicilio.@['noInt']=receptor.selectedItem[10];
				receptorDomicilio.@['colonia']=receptor.selectedItem[6];
				receptorDomicilio.@['cp']=receptor.selectedItem[5];
				receptorDomicilio.@['municipio']=receptor.selectedItem[8];
				receptorDomicilio.@['estado']=receptor.selectedItem[7];
				receptorDomicilio.@['pais']=receptor.selectedItem[11];
				
				receptorInput.appendChild(receptorDomicilio);
				inputAddendas.appendChild(receptorInput);
				
				//Al xml donde enviamos información de entrada le agregamos toda la información de conceptos
				var partidas:XML=new XML("<partidas/>");
				var partidaXML:XML;
				var idx1:int;
				var idx2:int;
				for (idx1=0;idx1<gb.length;idx1++)
				{
					partidaXML= new XML("<partida/>");
					idx2=0;
					partidaXML.@['numero']=idx1.toString();
					do
					{		
						partidaXML.@['dato'+idx2.toString()]=gb[idx1][idx2].toString();
						idx2++;
					}
					while(gb[idx1].hasOwnProperty([idx2]));
					partidas.appendChild(partidaXML);
				}
				inputAddendas.appendChild(partidas);
				//Ahora le agregaremos los datos de los totales
				var totales:XML = new XML("<totales/>");
				var itemTotales:XML;
				for (idx1=0;idx1<gbTotales.length;idx1++)
				{
					itemTotales= new XML("<itemTotales/>");
					idx2=0;
					itemTotales.@['numero']=idx1.toString();
					do
					{		
						itemTotales.@['dato'+idx2.toString()]=gbTotales[idx1][idx2].toString();
						idx2++;
					}
					while(gbTotales[idx1].hasOwnProperty([idx2]));
					totales.appendChild(itemTotales);
				}
				inputAddendas.appendChild(totales);
				//inputAddendas.child("Partidas").@['abc']="def";
				loadedASM.application["setParametros"](inputAddendas);
				trace(inputAddendas.toXMLString());
			}
			
			private function confirmaCancelaAddenda()
			{
				//No habrá addenda
				Alert.okLabel="Si";
				Alert.show("¿Confirma que no desea agregar Addenda/Complemento a este comprobante?","Aviso",Alert.OK | Alert.CANCEL, this, cierraAddenda, iconQuestion, Alert.OK);
			}
			private function cierraAddenda(eventObj)
			{
				if (eventObj==null||eventObj.detail==Alert.OK) 
				{
					if(!(eventObj==null)&& eventObj.detail==Alert.OK)
					{
						usaAddenda.text="0";
						addendaContenido.text="";
					}
					loadedASM=null;
					addendaLoader.unloadAndStop(true);
					contenedorAddenda.visible=false;
					sendGeneraCFDI();
				}
				
				
			}
			private function validaMensaje():void
			{
				var result:Array= new Array();
				result=lowCreditos.text.split("|");
				if(result[0].toString()=="True")
				{
					Alert.show("Le informamos que actualmente cuenta usted con "+result[1].toString()+" créditos para generar CFDIs, le recomendamos ponerse en contacto con nuestra área de ventas. \nNota: En caso de que se agoten sus créditos, será migrado a una versión austera del sistema y sus diseños para impresión de CFDIs serán cambiados por el diseño incluido por defecto en el sistema.", "Mensaje FacturaXion",Alert.OK,null, null, iconAlert);
				}
			}
			private function truncaRedondeaDecimales(trnRdn:int/*0 trunca, 1 redondea*/,nmr:Number,cDec:int/*Cantidad de decimales*/):Number
			{
				
					var tmpArr:Array= new Array();
				
					tmpArr=nmr.toString().split(".",2);
					if(tmpArr.length==1)// Si es un entero
					{
						return nmr;
					}
					else if(trnRdn==0)// Si hay que truncar
					{
						tmpArr[1]=tmpArr[1].toString().substr(0,cDec);
						return Number(tmpArr[0].toString()+"."+tmpArr[1].toString());
					}
					else if(trnRdn==1)// Si hay que redondear
					{
						var residuo:int =int(tmpArr[1].toString().substr(cDec,1));
						if (residuo<5)
						{
							tmpArr[1]=tmpArr[1].toString().substr(0,cDec);
							return Number(tmpArr[0].toString()+"."+tmpArr[1].toString());
						}
						else
						{
							//return Number(tmpArr[0].toString()+"."+tmpArr[1].toString().substr(0,cDec-1)+int(tmpArr[1].toString().substr(cDec-1,1))-1);
							var rdn:Number=Math.round(nmr*Math.pow(10,cDec))/Math.pow(10,cDec);
							return rdn;
						}
					}
					return nmr;
			}
			private function setRestringeGratuito():void
			{
				if (Number(idRol.text)==16)
				{
					btnAddProducto.enabled=false;
					enviaCfdiXMail.enabled=false;
					correoVMSG.enabled=false;
					correoVPara.enabled=false;
					correoVCC.enabled=false;
					correoVCCo.enabled=false;
				}
				else
				{
					btnAddProducto.enabled=true;
					enviaCfdiXMail.enabled=true;
					correoVMSG.enabled=true;
					correoVPara.enabled=true;
					correoVCC.enabled=true;
					correoVCCo.enabled=true;
				}
			}
			private function arrancaTimer():void
			{
				if (Number(idRol.text)==16)
				{
					temporizador=new Timer(1000,30);
					temporizador.addEventListener(TimerEvent.TIMER,refrescaAnuncioTimer);
					temporizador.addEventListener(TimerEvent.TIMER_COMPLETE,terminaEspera);
					anuncioTimer.visible=true;
					entrarFacturar.enabled=false;
					temporizador.start();
				}
				else
				{
					entrar();
				}
			}
			private function refrescaAnuncioTimer(myTimerEvent:Event):void
			{
				anuncioTimer.text="Por favor espere " + (30-temporizador.currentCount).toString()+ " segundos.";
			}
			private function terminaEspera(myTimerEvent:Event):void
			{
				temporizador.stop();
				anuncioTimer.visible=false;
				entrar();
			}
			
			
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<mx:Sequence id="glowIcon" repeatCount="100">
			<mx:Glow duration="1000" alphaFrom="0.1" alphaTo="0.9" blurXFrom="0.0" blurXTo="6.0" blurYFrom="0.0" blurYTo="6.0" color="#FFFF00" /> 	
			<mx:Glow duration="1000" alphaFrom="0.9" alphaTo="0.1" blurXFrom="6.0" blurXTo="0.0" blurYFrom="6.0" blurYTo="0.0" color="#FFFF00" /> 	
		</mx:Sequence>
		<mx:CurrencyValidator source="{cant}" property="text" decimalPointCountError="El punto decimal sólo se puede agregar una vez."  requiredFieldError="Este campo es requerido." precision="2" invalidCharError="La cantidad contiene caracteres inválidos" maxValue="999999999"  allowNegative="false" thousandsSeparator="," exceedsMaxError="El valor debe de ser menor a 999,999,999.99" lowerThanMinError="El valor debe de ser mayor a 0" precisionError="La cantidad debe de ser numérica con dos posiciones decimales." valid="cantValid.text = '0';" invalid="cantValid.text = '1'" trigger="{cant}" triggerEvent="focusOut"/>
		<mx:CurrencyValidator source="{precio}" property="text" decimalPointCountError="El punto decimal sólo se puede agregar una vez." requiredFieldError="Este campo es requerido." invalidCharError="El precio contiene caracteres inválidos" precision="2" maxValue="999999999" allowNegative="false" thousandsSeparator=","  exceedsMaxError="El valor debe de ser menor a 999,999,999.999999" lowerThanMinError="El valor debe de ser mayor a 0" precisionError="El precio debe de ser numérico con dos posiciones decimales." valid="precioValid.text = '0';" invalid="precioValid.text = '1'" trigger="{precio}" triggerEvent="focusOut"/>
		<mx:CurrencyValidator source="{precioUnitarioAdd}" decimalPointCountError="El punto decimal sólo se puede agregar una vez." requiredFieldError="Este campo es requerido." invalidCharError="El precio contiene caracteres inválidos" property="text" maxValue="999999999" thousandsSeparator="," exceedsMaxError="El valor debe de ser menor a 999,999,999.999999" lowerThanMinError="El valor debe de ser mayor a 0" allowNegative="false"  precision="6" precisionError="El precio debe de ser numérico con seis posiciones decimales." valid="precioAddValid.text = '0';" invalid="precioAddValid.text = '1'" trigger="{precioUnitarioAdd}" triggerEvent="focusOut"/>
		<mx:CurrencyValidator source="{tasaCambio}" property="text" decimalPointCountError="El punto decimal sólo se puede agregar una vez."  requiredFieldError="Este campo es requerido." precision="6" invalidCharError="La cantidad contiene caracteres inválidos" maxValue="999999999"  allowNegative="false" thousandsSeparator="," exceedsMaxError="El valor debe de ser menor a 999,999,999.999999" lowerThanMinError="El valor debe de ser mayor a 0" precisionError="La cantidad debe de ser numérica con seis posiciones decimales." valid="tasaValid.text = '0';" invalid="tasaValid.text = '1'" trigger="{tasaCambio}" triggerEvent="focusOut"/>
		
		
		
		
		<mx:CurrencyValidator source="{txtImporteUnit}" decimalPointCountError="El punto decimal sólo se puede agregar una vez." requiredFieldError="Este campo es requerido." invalidCharError="El importe unitario contiene caracteres inválidos" property="text" maxValue="999999999" thousandsSeparator="," exceedsMaxError="El valor debe de ser menor a 999,999,999.999999" lowerThanMinError="El valor debe de ser mayor a 0" allowNegative="false"  precision="2" precisionError="El precio debe de ser numérico con dos posiciones decimales." valid="txtImporteUnitValid.text = '0';" invalid="txtImporteUnitValid.text = '1'" trigger="{txtImporteUnit}" triggerEvent="focusOut"/>
		<mx:CurrencyValidator source="{txtImporteTotal}" property="text" decimalPointCountError="El punto decimal sólo se puede agregar una vez." requiredFieldError="Este campo es requerido." invalidCharError="El precio contiene caracteres inválidos" precision="2" maxValue="999999999" allowNegative="false" thousandsSeparator=","  exceedsMaxError="El valor debe de ser menor a 999,999,999.999999" lowerThanMinError="El valor debe de ser mayor a 0" precisionError="El precio debe de ser numérico con dos posiciones decimales." valid="precioValid.text = '0';" invalid="precioValid.text = '1'" trigger="{txtImporteTotal}" triggerEvent="focusOut"/>
		
		
	</fx:Declarations>
	
	<s:TextInput x="255" y="101" id="txtImporteUnit" width="106" restrict="0-9." focusOut="if(txtImporteUnit.text.length > 0) txtImporteUnit.errorString = ''"/>
	<s:TextInput x="370" y="101" id="txtImporteTotal" width="106" restrict="0-9." focusOut="if(txtImporteTotal.text.length > 0) txtImporteTotal.errorString = ''"/>
				 
		<s:TextInput id="txtImporteUnitValid" visible="false" x="10" y="10" width="20" height="15" text="1"/>
		<s:TextInput id="txtImporteTotalValid" visible="false" x="10" y="10" width="20" height="15" text="1"/>
	
				 
		
	<!--Campos enviados para la generación del XML y PDF-->	
	<s:TextInput id="cantValid" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="precioValid" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="precioAddValid" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="tasaValid" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="validaExisteClientes" visible="false" x="10" y="10" width="20" height="15" valueCommit="cargaDatos();"/>
	
	<!--Campos enviados para la generación del XML y PDF-->	
	<s:TextInput id="idRol" visible="false" x="10" y="10" width="20" height="15" valueCommit="setRestringeGratuito()"/>
	<s:TextInput id="rfcEmisor" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="nombreEmisor" x="52" y="81.8" fontSize="9"  visible="false"/>
	<s:TextInput id="idEmisor" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="idSucursalEmisor" visible="false" x="10" y="10" width="20" height="15" />
	
	<!--Campos que tomarán valores necesarios para addendas (Domicilio de la matriz)-->
	<s:TextInput id="idSucursalMatriz" x="10" y="20" width="20" height="15" visible="false"/>
	<s:TextInput id="nombreSucursalMatriz" x="10" y="20" width="20" height="15" visible="false"/>
	<s:TextInput id="paisMatriz" x="10" y="40" width="20" height="15" visible="false"/>
	<s:TextInput id="cpMatriz" x="10" y="60" width="20" height="15" visible="false"/>
	<s:TextInput id="estadoMatriz" x="10" y="80" width="20" height="15" visible="false"/>
	<s:TextInput id="ciudadMatriz" x="10" y="100" width="20" height="15" visible="false"/>
	<s:TextInput id="municipioMatriz" x="10" y="120" width="20" height="15" visible="false"/>
	<s:TextInput id="coloniaMatriz" x="10" y="140" width="20" height="15" visible="false"/>
	<s:TextInput id="calleMatriz" x="10" y="160" width="20" height="15" visible="false"/>
	<s:TextInput id="noExtMatriz" x="10" y="180" width="20" height="15" visible="false"/>
	<s:TextInput id="noIntMatriz" x="10" y="200" width="20" height="15" visible="false"/>
	<s:TextInput id="emailSucMatriz" x="10" y="220" width="20" height="15" visible="false"/>	
	
	<!--Campos que tomarán valores necesarios para addendas (Domicilio de la sucursal de expedición)-->
	<s:TextInput id="nombreSucursalEmitidoEn" x="10" y="40" width="20" height="15" visible="false"/>
	<s:TextInput id="paisEmitidoEn" x="10" y="40" width="40" height="15" visible="false"/>
	<s:TextInput id="cpEmitidoEn" x="10" y="60" width="40" height="15" visible="false"/>
	<s:TextInput id="estadoEmitidoEn" x="10" y="80" width="40" height="15" visible="false"/>
	<s:TextInput id="ciudadEmitidoEn" x="10" y="100" width="40" height="15" visible="false"/>
	<s:TextInput id="municipioEmitidoEn" x="10" y="120" width="40" height="15" visible="false"/>
	<s:TextInput id="coloniaEmitidoEn" x="10" y="140" width="40" height="15" visible="false"/>
	<s:TextInput id="calleEmitidoEn" x="10" y="160" width="40" height="15" visible="false"/>
	<s:TextInput id="noExtEmitidoEn" x="10" y="180" width="40" height="15" visible="false"/>
	<s:TextInput id="noIntEmitidoEn" x="10" y="200" width="40" height="15" visible="false"/>
	<s:TextInput id="emailSucEmitidoEn" x="10" y="220" width="40" height="15" visible="false"/>
	<s:TextInput id="importeTotal" x="10" y="240" width="40" height="15" visible="false"/>
	<s:TextInput id="importeTotalLetra" x="10" y="240" width="40" height="15" visible="false"/>
	
	<s:TextInput id="isConfigured" visible="false" x="10" y="30" width="20" height="15"/>
	
	<s:TextInput id="rfcReceptor" visible="false" x="10" y="6" width="96" height="18"/>	
	<s:TextInput id="nombreReceptor" visible="false" x="10" y="6" width="96" height="18"/>	
	<s:TextInput id="idReceptor" visible="false" x="10" y="10" width="20" height="15"/>
	<s:TextInput id="idSucursalReceptor" visible="false" x="387" y="10" width="20" height="15" />
	
	<s:TextInput id="idSerie" visible="false" x="387" y="10" width="20" height="15" />
	<s:TextInput id="tipoMonedaR" visible="false" x="387" y="10" width="20" height="15" />
	<s:TextInput id="tasaCambioR" visible="false" x="387" y="10" width="20" height="15" />
	<s:TextInput id="metodoPagoR" visible="false" x="387" y="10" width="20" height="15" />
	<s:TextInput id="noOrdenCompraR" visible="false" x="387" y="10" width="20" height="15" />
	<!--<s:TextInput id="tipoCFDI" visible="false" x="387" y="10" width="20" height="15" text="ingreso"/>-->
	<s:TextInput id="tipoCFDI" visible="true" x="387" y="10" width="20" height="15"/>
	<s:TextInput id="procedencia" visible="false" x="387" y="10" width="20" height="15" text="1"/>
	<s:TextInput id="tipoComprobante" visible="true" x="10" y="10" width="20" height="15" />
	<!--<s:TextInput id="tipoComprobante" visible="false" x="10" y="10" width="20" height="15" text="1"/>-->
	
	
	
	<s:TextInput id="RAND" visible="false" x="387" y="10" width="20" height="15" valueCommit="seleccionarReceptor();" />
	
	<s:TextInput id="acProductoPasoText" visible="false" x="340" y="10" width="20" height="15" valueCommit="fillControls();"/>
	
	
	<s:Panel width="100%" height="100%" title="CFDI Simple"  id="wGFE" color="#282323" x="1" y="1">
		<s:TextInput x="127" y="155.5" width="100" restrict="0-9." id="cant" tabIndex="7" maxChars="16" height="24" text="1"/>
		<s:TextInput x="239" y="155.5" width="100" restrict="0-9." id="precio" tabIndex="8" maxChars="16" height="22"/>
		<s:NumericStepper x="349" y="155.5" id="descuento" minimum="0" maximum="100" stepSize=".01"  tabIndex="9" width="100" height="24" />
		<s:ComboBox x="462" y="155.5" width="235" id="impuesto" labelField="1" tabIndex="10" height="24"></s:ComboBox>
		<s:ComboBox x="18" y="156.5" width="97" id="um" labelField="1" tabIndex="6" height="24"></s:ComboBox>
		<s:Label x="19" y="69" text="Concepto"/>
		<s:Label x="21" y="453" text="Observaciones"/>
		<s:Label x="128" y="142" text="Cantidad"/>
		<s:Label x="18" y="143" text="Unidad de Medida"/>
		<s:Label x="238" y="142.5" text="Precio Unitario"/>
		<s:Label x="349" y="140.5" text="% Desc."/>
		<s:Label x="461" y="139.5" text="Impuesto"/>
		
		<mx:Image source="newIcons/interrogacion.png" click="ayuda();" creationCompleteEffect="{glowIcon}" y="-30" right="30"/>
		
		<s:Label x="516" y="356" text="0.00" width="101" textAlign="right" fontWeight="normal" id="tST" visible="false"/>
		<s:Label x="528" y="372.95" text="0.00" width="89" textAlign="right" fontWeight="normal" id="tDesc" visible="false"/>
		<s:Label x="516" y="393" text="0.00" width="100" textAlign="right" fontWeight="normal" id="tIVA" visible="false"/>
		<s:Label x="516" y="412" text="0.00" width="100" textAlign="right" fontWeight="normal" id="tRet" visible="false"/>
		<s:Label x="505" y="432" text="0.00" width="111" textAlign="right" fontWeight="bold" id="tNeto" visible="false"/>
		<s:TextArea x="20" y="95" width="678" height="31.5" id="concepto" maxChars="2500" tabIndex="100" visible="false"/>
		
		<components:AutoComplete id="autocompleteProductosText" tabIndex="4" dataProvider="{ acACProductos }" valueCommit="verItemSelect();"  width="678" allowMultipleSelection="false" allowNewValues="true" allowEditingNewValues="true" labelField="name" dropDownLabelFunction="dropDownLabelFunction" matchType="word" x="19" y="83" height="48" />
		
		<s:TextArea x="19" y="369" width="620" height="80" id="observaciones" maxChars="2500" tabIndex="13"/>
		<mx:Button x="709" y="153.5" label="Agregar" id="agregar"  click="add()" tabIndex="11" height="24" width="100" icon="@Embed(source='newIcons/add_24.png')"/>
		<mx:Button x="708" y="84.5" id="btnAddProducto" label="Concepto" height="24" click="modal.visible = true; addProducto.isPopUp = true; addProducto.visible = true; descripcionAdd.setFocus(); disableAllcontrols();" tabIndex="5" width="100" icon="@Embed(source='newIcons/add_24.png')"/>
		
		<mx:DataGrid x="19" y="193" width="900" height="24" id="conHead" editable="false" resizableColumns="true" sortableColumns="false">
			<mx:columns>
				<mx:DataGridColumn headerText="Cantidad" width="60"  dataField="0"/>
				<mx:DataGridColumn headerText="Concepto"  dataField="1" width="400" />
				<mx:DataGridColumn headerText="Precio Unitario" width="120"  dataField="2" textAlign="right"/>
				<mx:DataGridColumn headerText="Con Descuento" width="120"  dataField="2" textAlign="right"/>
				<mx:DataGridColumn headerText="Importe" width="120" dataField="3" textAlign="right"/>
			</mx:columns>
		</mx:DataGrid>
		
		<mx:DataGrid x="19" y="216" width="900"  variableRowHeight="true" height="150" id="conceptos" editable="false" showHeaders="false" wordWrap="true">
			<mx:columns>					
				<mx:DataGridColumn headerText="Concepto" dataField="0" itemRenderer="conceptosRenderer" />		
			</mx:columns>
		</mx:DataGrid>
		
		<mx:DataGrid x="641" y="369" width="278" showHeaders="false" height="80" id="totales" fontWeight="bold" textAlign="right" creationComplete="addTotales();" resizableColumns="false" >
			<mx:columns>
				<mx:DataGridColumn headerText="Column 1" dataField="2" paddingRight="5" textAlign="right"/>
				<mx:DataGridColumn headerText="Column 2" width="120" dataField="3" paddingRight="5" textAlign="right"/>					
			</mx:columns>
		</mx:DataGrid>
		<mx:Button x="906" y="242" label="Generar Documento" icon="@Embed(source='assets/print.png')" click="generarDocumento();" visible="false" height="32"/>
		
		
		<!---->
		<s:TextInput x="79" y="4" id="searchCliente" 
					 valueCommit="if(searchCliente.text.length > 2){Send(639);}" 
					 width="140" maxChars="13" restrict="A-Za-z0-9ñÑ&amp;"
					 typographicCase="uppercase" height="24" visible="false"/>
		
		<s:ComboBox x="21" y="33" id="receptor" width="424" height="24" itemRenderer="personaRender" 
					change="seleccionarReceptor();" labelField="11" tabIndex="1"/>
		
		<!--<s:ComboBox x="21" y="33" id="receptor" width="424" height="24" itemRenderer="personaRender" 
					change="seleccionarReceptor();" labelField="11" tabIndex="1" 
					keyDown="searchCliente.text = receptor.textInput.text;" 
					toolTip="Si su Cliente no se encuentra en esta lista, puede buscarlo tecleando parte del Nombre o RFC"/>-->
		
		<!--<s:ComboBox x="21" y="33" id="receptor" width="402" height="24" itemRenderer="personaRender" 
					change="seleccionarReceptor();" labelField="11" tabIndex="5" />-->
		<!---->		
		<s:Label x="21" y="18" text="Receptor"/>
		<mx:Button x="817" y="154" label="Eliminar" click="remove();" height="24" width="100" icon="@Embed(source='newIcons/delete_24.png')" id="eliminar" tabIndex="12"/>
		
		<mx:DataGrid x="1020" y="247" id="acProductosGV" visible="false" valueCommit="loadACproductos();">
			<mx:columns>
				<mx:DataGridColumn headerText="" dataField="0"/>
				<mx:DataGridColumn headerText="" dataField="1"/>
			</mx:columns>
		</mx:DataGrid>
		
		<!--Controles a los que llega la ruta de los XML y PDF generados en el sistema-->
		<s:TextInput x="34" y="272" width="318" visible="false" id="rutaPDF" valueCommit="viewTWCFD();"/>
		<s:TextInput x="34" y="313" width="318" visible="false" id="rutaXML" />
		
		<!--Controles de Envío de correo electrónico-->
		<s:TextInput x="369" y="263" visible="false" id="correo"   valueCommit="correoVPara.text = correo.text;" />
		<s:TextInput x="369" y="294" visible="false" id="correoCC" valueCommit="correoVCC.text   = correoCC.text;" />
		<s:TextInput x="369" y="310" visible="false" id="lowCreditos" enabled="false" valueCommit="validaMensaje();"/>
		<s:TextInput x="369" y="325" visible="false" id="correoCCo" />
		<s:TextInput x="369" y="356"  visible="false" id="correoMSG" />		
		<s:TextInput x="34" y="313" width="318" visible="false" id="correoEnviado" valueCommit="validSendEmail();" />
		
		
		<s:Label x="464" y="18" text="Serie"/>
		<s:Label x="597.5" y="18" text="Fecha"/>
		<mx:DateField x="597.5" y="33" showToday="true" id="fecha" creationComplete="fecha.selectedDate = new Date();" editable="false" width="124" color="#000000" height="24" enabled="false" tabIndex="3"/>
		<s:ComboBox x="463" y="33" id="folio" width="122" labelField="2" color="#000000" height="24" tabIndex="2"></s:ComboBox>		
		
		<mx:Button x="819" y="452" label="Generar" click=" validaGenerarFactura();" width="100" height="24" icon="@Embed(source='newIcons/accept_24.png')" tabIndex="14" id="generar"/>
		<mx:Button label="Cerrar" icon="@Embed(source='newIcons/delete_24.png')" click=" salir();" height="18" width="7" right="16" top="-25"/>
		<mx:Button x="641" y="452" label="Campos Adicionales" icon="@Embed(source='assets/2718-32.png')" click="TTWvalores.visible = true;" height="24" width="170" tabIndex="4" id="btnAdendas" visible="false"/>
		<s:CheckBox x="24" y="474" label="Comprobante de Donatarias" width="163" id="usaDonatarias" enabled="false" visible="true" tabIndex="15"/>
		
		<s:Panel width="100%" height="100%" visible="false" id="modal" x="1" y="-30" backgroundColor="#635E5E" alpha=".5">
		</s:Panel>
		
		
		<s:TitleWindow id="initFact" visible="true" width="304" height="322" close="salir();" horizontalCenter="4" verticalCenter="-197">
			<s:ComboBox x="19" y="26" id="tipoMoneda" width="125" height="24" change="setTasa();" labelField="11" tabIndex="1"></s:ComboBox>
			<s:Label x="19" y="13" text="Tipo de Moneda"/>
			<s:Label x="19" y="62" text="Método de Pago"/>
			<s:Label x="156" y="13" text="Tasa de Cambio"/>
			<s:Label x="20" y="110" text="Número de órden de compra"/>
			<s:Label x="20" y="159" text="Tipo de CFDI"/>
			
			<s:TextInput x="156" y="25.5" width="125" height="23" id="tasaCambio" maxChars="2500" tabIndex="100" editable="false" text="1" />
			<s:TextInput x="20" y="123" width="260" height="23" id="noOrdenCompra" maxChars="20" tabIndex="3"/>
			
			<s:TextInput x="9" y="165" width="52" height="23" id="countCamposAdicionales" maxChars="20" visible="false"/>
			<s:TextInput x="18" y="75" width="263" height="24" id="metodoPago" text="Efectivo" tabIndex="2"/>
			<mx:Button x="157" y="232" label="Entrar" icon="@Embed(source='newIcons/accept_24.png')" click="arrancaTimer();" height="24" width="100" tabIndex="4" id="entrarFacturar"/>
			<mx:Button x="48" y="233" label="Cerrar" icon="@Embed(source='newIcons/delete_24.png')" click=" salir(); initFact.visible = false; " height="24" width="100" tabIndex="99"/>
			<s:ComboBox x="20" y="173" id="cTipoCFDI" creationComplete="Send(680);" width="260" height="24" change="setTipoCFDI();" labelField="11" tabIndex="4"></s:ComboBox>
			<s:Label x="20" y="211" text="Decimales"/>
			<s:RadioButton x="83" y="205" label="Truncados" width="79" selected="true"  id="decTruncados" toolTip="Default, con esta opción los cálculos de decimales se truncarán a 2 dígitos"/>
			<s:RadioButton x="170" y="205" label="Redondeados" width="89" id="decRedondeados" toolTip="Con esta opción los cálculos de los totales se dedondearán al centésimo más próximo"/>
			<s:Label x="50" y="267" text="Por favor espere:" width="200" id="anuncioTimer" visible="false"  color="#1B3EC2" fontWeight="bold"/>
			
		</s:TitleWindow>
		
		<s:TitleWindow height="454" id="contenedorAddenda" enabled="true" title="Inserción de Addendas/Complementos" right="97" left="37" verticalCenter="-190" visible="false" close="confirmaCancelaAddenda();">
			<s:ComboBox x="20" y="26" id="listadoAddendasReceptor"/>
			<mx:Button x="180" y="26" id="cargaAddenda" label="Capturar" icon="@Embed(source='newIcons/accept_24.png')" height="24" width="100" click="cargaPantallaAddenda();"/>
			<mx:Button x="292" y="26" id="cancelaAddenda" label="Cancelar" icon="@Embed(source='newIcons/delete_24.png')" height="24" width="100" click="confirmaCancelaAddenda();"/>
			<s:Label x="23" y="12" text="Addenda/Complemento" width="121"/>
			<mx:SWFLoader height="334" left="20" right="23" y="61" id="addendaLoader"/>
			<s:TextInput x="440" y="32" id="usaAddenda" enabled="false" visible="false" width="30" text="0"/>
			<s:TextInput x="470" y="32" id="addendaContenido" enabled="false" visible="false" width="30"/>
			<s:TextInput x="500" y="32" id="idAddenda" width="30" enabled="false" visible="false" text="-1"/>
			<s:TextInput x="530" y="32" id="locNameSpace" width="30" enabled="false" visible="false"/>
			<s:TextInput x="560" y="32" id="locSchema" width="30" enabled="false" visible="false"/>
			<s:TextInput x="590" y="32" id="nombreSchema" width="30" enabled="false" visible="false"/>
			<s:TextInput x="620" y="32" id="definidoEn" width="30" enabled="false" visible="false"/>
			<s:TextInput x="650" y="32" id="nameSpace" width="30" enabled="false" visible="false"/>
			<s:Label x="20" y="32" text="Complemento" width="146" height="14" id="lblComplementoNombre"/>
		</s:TitleWindow>
		<s:TextInput x="726" y="33" id="cCountAddendas" visible="false" enabled="false"/>
		
		
	</s:Panel>	
	
	<!--Title Window de altas de productos-->
	<s:TitleWindow id="addProducto" visible="false" width="275" height="280" close="addProducto.visible = false; modal.visible = false; enabledAllControls();" title="Agregar Producto" x="644" y="43">
		<s:TextArea x="10" y="28" width="250" id="descripcionAdd" tabIndex="4"  height="56"/>
		<s:Label x="10" y="10" text="Descripción del Concepto" width="145"/>
		<s:TextInput x="10" y="105" width="250" id="descripcionCortaAdd" tabIndex="4" height="24"/>
		<s:Label x="10" y="92" text="Descripción corta del Concepto" width="207"/>
		<s:TextInput x="10" y="197" width="125" id="precioUnitarioAdd" restrict="0-9." tabIndex="4" height="24"/>
		<s:Label x="10" y="182" text="Precio Unitario" width="164"/>
		<s:Label x="10" y="137" text="Unidad de Medida" width="207"/>
		<s:ComboBox x="10" y="150" id="umAdd" width="125" height="24" labelField="11"></s:ComboBox>
		<mx:Button x="161" y="195.95" label="Agregar" id="addProductoInDB" icon="@Embed(source='newIcons/add_24.png')" height="24" width="100" tabIndex="7" click="addProductoAndValid();"/>
	</s:TitleWindow>
	
	<!--Title Window para escupir o enviar el XML o PDF generado-->
	<s:TitleWindow id="factura" width="592" height="363" backgroundColor="#ffffff" visible="false" title="Ver o enviar CFDI." close="closeTWCFD();" horizontalCenter="-5" y="150" >
		<mx:Image x="-0.5" y="-2" id="imageMSGFact" source="newIcons/enterprises copia.png" visible="true"/>
		<s:Label x="64.5" y="24" visible="true" text="¿Desea imprimir o enviar este CFDI?"  fontSize="17" fontWeight="bold"/>		
		
		<s:TextInput x="30.5" y="80" width="250"   id="correoVPara" valueCommit="correo.text = correoVPara.text;"   change="if(correoVPara.text!=&quot;&quot;){checkMail(correoVPara);}"  height="24" toolTip="Agregue sólo una dirección de correo"/>
		<s:TextInput x="31.5" y="124" width="250"   id="correoVCC"   valueCommit="correoCC.text = correoVCC.text;"    height="24" toolTip="Agregue una o varias cuentas de correo separadas con punto y coma (;)"/>
		<s:TextInput x="31.5" y="168" width="250"   id="correoVCCo"  valueCommit="correoCCo.text = correoVCCo.text;"  height="24"  toolTip="Agregue una o varias cuentas de correo separadas con punto y coma (;)"/>
		<s:TextArea  x="297"  y="79" width="250" id="correoVMSG"  valueCommit="correoMSG.text = correoVMSG.text;" height="113"/>
		
		<s:Label x="29.5" y="67" visible="true" text="Para : "/>
		<s:Label x="299" y="66" visible="true" text="Mensaje : "/>
		<s:Label x="33.5" y="111" visible="true" text="Cc : "/>
		<s:Label x="31.5" y="155" visible="true" text="CCo : "/>
		
		<s:TextInput x="0" y="0" width="0" visible="false" enabled="false" height="0" id="idCfdi" valueCommit="Send(594);"/>
		
		<mx:Button x="32" y="225" click="navegarPDF();" label="      Visualizar CFDI en PDF" height="24" fontWeight="bold"  width="250" icon="@Embed(source='assets/pdf-64X64.png')"/>
		<mx:Button x="297" y="224" click="navegarXML();" label="      Visualizar CFDI en XML" height="24" fontWeight="bold"  width="250" icon="@Embed(source='newIcons/R_64.png')"/>
		<mx:Button x="297" y="279" click="enviarFactEmail();" label="  Enviar CFDI por Correo" height="24" fontWeight="bold"  width="250" icon="@Embed(source='assets/mail-64X64.png')" id="enviaCfdiXMail"/>		
	</s:TitleWindow>
	
	
	<mx:TitleWindow id="TTWvalores" title="CAMPOS ADICIONALES" visible="false" showCloseButton="false" width="684"
					height="322" layout="absolute" borderAlpha=".95" horizontalCenter="-50" y="215" verticalCenter="-200">
		<s:VGroup width="100%" height="100%" horizontalAlign="left"  paddingRight="5" paddingLeft="5" paddingTop="5" paddingBottom="5">
			<!--<mx:Label text="El diseño de su CFDI cuenta con campos adicionales."  fontWeight="bold"/>-->
			<mx:Label text="  El diseño de su CFDI contiene Campos Adicionales.  Asigne un valor dando doble click en la Descripción de cada Campo."  fontWeight="normal" paddingTop="10"/>
			<s:HGroup width="100%" height="100%" horizontalAlign="left"  paddingRight="5" paddingLeft="5" paddingTop="5" paddingBottom="5">
				<mx:DataGrid width="100%" height="100%" verticalAlign="top" id="GWV_FECamposValores" horizontalScrollPolicy="on" verticalScrollPolicy="auto" wordWrap="true" headerStyleName="headerStyle" click="muestraValIdConFactDetDesc();" doubleClickEnabled="true" doubleClick="muestraTTWcambiaValor();">
					<mx:columns>
						<mx:DataGridColumn headerText="idConFactDetDesc"							dataField="0" paddingLeft="10" paddingRight="10" width="80" visible="false"/>
						<mx:DataGridColumn headerText="Descripción"									dataField="1" paddingLeft="10" paddingRight="10" width="200"/>
						<mx:DataGridColumn headerText="Valor"										dataField="2" paddingLeft="10" paddingRight="10" width="100"/>
					</mx:columns>
				</mx:DataGrid>
			</s:HGroup>	
			<s:HGroup width="100%" horizontalAlign="right"  paddingRight="5" paddingLeft="5" paddingTop="5" paddingBottom="5">
				<s:TextInput id="idConFactDetDesc" visible="false" width="45" x="516"/>
				<mx:Button label="Aceptar" icon="@Embed(source='newIcons/accept_24.png')" click=" TTWvalores.visible = false; modal.visible = false;" height="24" width="100" tabIndex="3" x="567"/>
			</s:HGroup>
		</s:VGroup>
	</mx:TitleWindow>
	
	<mx:TitleWindow id="TTWcambiaValor" title="Asignar Valor" visible="false" showCloseButton="true" close="TTWvalores.enabled = true;TTWcambiaValor.visible = false;"  
					layout="absolute" borderAlpha=".95" horizontalCenter="0" y="177" height="89" width="481">
		<mx:HBox width="479" height="100%" horizontalAlign="left"  paddingRight="5" paddingLeft="5" paddingTop="5" paddingBottom="5">
			<mx:Label id="LBLDescripcion" text="" fontWeight="bold"/>
			<s:TextInput id="valor" width="145"/>
			<mx:Spacer width="5"/>
			<mx:Button label="Aceptar" icon="@Embed(source='newIcons/accept_24.png')" click="actualizaValor();" height="24" width="100" tabIndex="3"/>
		</mx:HBox>
	</mx:TitleWindow> 
	
</s:Application>